image: node:14

cache:
  key:
    files:
      - package.json
      - package-lock.json
  paths:
    - .npm/

.build:
  stage: build
  script:
    - "which cwebp || ( apt-get update -y && apt-get install webp -y )"
    - npm ci --cache .npm --prefer-offline
    - npm run test
    - npm run build-$CI_ENVIRONMENT_NAME
  artifacts:
    paths:
      - dist/

.deploy:
  stage: deploy
  image: alpine:latest
  script:
    - apk add openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - rsync -avz -e 'ssh -p2201' --delete dist/ $SFTP_SERVER

build:dev:
  extends: .build
  environment:
    name: dev
deploy:dev:
  extends: .deploy
  environment:
    name: dev
  needs:
    - build:dev
  only:
    - master
    - ci
deploy:dev:manual:
  extends: .deploy
  environment:
    name: dev
  needs:
    - build:dev
  when: manual

build:beta:
  extends: .build
  environment:
    name: beta
deploy:beta:
  extends: .deploy
  environment:
    name: beta
  needs:
    - build:beta
  only:
    - master
    - ci
deploy:beta:manual:
  extends: .deploy
  environment:
    name: beta
  needs:
    - build:beta
  when: manual

build:prod:
  extends: .build
  environment:
    name: prod
deploy:prod:
  extends: .deploy
  environment:
    name: prod
  needs:
    - build:prod
  only:
    - tags
  when: manual
